---
import PostActivity from '@/components/Widgets/PostActivity.astro'
import PostList from '@/components/PostList.astro'
import { defaultLocale, moreLocales } from '@/config'
import { ui } from '@/i18n/ui'
import Layout from '@/layouts/Layout.astro'
import { getPosts, getPostsByYear } from '@/utils/content'
import { getPageInfo } from '@/utils/page'

export async function getStaticPaths() {
  type PathItem = {
    params: { archive: string }
    props: { lang: string }
  }

  const paths: PathItem[] = []

  // 默认语言
  paths.push({
    params: { archive: 'archive' },
    props: { lang: defaultLocale },
  })

  // 其他语言
  moreLocales.forEach((lang: string) => {
    paths.push({
      params: { archive: `${lang}/archive` },
      props: { lang },
    })
  })

  return paths
}

const { lang } = Astro.props
const { currentLang } = getPageInfo(Astro.url.pathname)
const currentUI = ui[currentLang as keyof typeof ui] ?? {}

const postlist = await getPosts(lang)
const postsByYear = await getPostsByYear(lang)
const totalPosts = postlist.length
const firstPostYear = postlist.length > 0 ? postlist[postlist.length - 1].data.published.getFullYear() : new Date().getFullYear()
const currentYear = new Date().getFullYear()
const yearSpan = currentYear - firstPostYear + 1;

---

<Layout>
  <!-- 装饰线 -->
  <div class="uno-decorative-line" />

  <!-- 页面标题 -->
  <div class="mb-12">
    <h1 class="mb-4 text-4xl c-primary font-bold font-title">
      {currentUI.archive || 'Archive'}
    </h1>
    <p class="text-lg c-secondary">
      {lang === 'zh' ? '按时间归档的所有文章' : 'All posts organized by time'}
    </p>
  </div>

  <!-- Post Activity Grid -->
  <PostActivity />



  <!-- 按年份分组的文章列表 -->
  <div class="archive-posts mt-16">
    <h2 class="mb-8 text-2xl font-bold c-primary">
      {currentUI.posts || 'Posts'}
    </h2>
    
    {[...postsByYear.entries()].map(([year, posts]) => (
      <section class="mb-12">
        <div class="year-header mb-6">
          <span class="year-number">{year}</span>
          <span class="post-count">({posts.length} {lang === 'zh' ? '篇' : 'posts'})</span>
        </div>
        <PostList posts={posts} lang={lang} />
      </section>
    ))}
    
    {postsByYear.size === 0 && (
      <div class="text-center py-12">
        <p class="text-lg c-secondary">
          {lang === 'zh' ? '暂无文章' : 'No posts yet'}
        </p>
      </div>
    )}
  </div>
</Layout>

<style>
  /* 归档页面样式优化 */
  .archive-posts {
    max-width: 100%;
  }
  
  .archive-posts h2 {
    position: relative;
  }
  
  .archive-posts h2::after {
    content: '';
    position: absolute;
    bottom: -4px;
    left: 0;
    width: 60px;
    height: 3px;
    background: linear-gradient(90deg, var(--c-primary), transparent);
    border-radius: 2px;
  }
  
  .archive-posts section {
    transition: all 0.3s ease;
  }
  
  .archive-posts section:hover {
    transform: translateY(-2px);
  }
  
  /* 年份标题样式 */
  .year-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  
  .year-number {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--c-primary);
    border: 2px solid var(--c-secondary); /* 普通边框，使用主题颜色 */
    border-radius: 0.375rem;
    background: transparent;
    transition: all 0.3s ease;
  }
  
  .year-number:hover {
    background: var(--c-secondary);
    color: var(--c-bg);
    transform: scale(1.05);
  }
  
  .post-count {
    font-size: 0.875rem;
    font-weight: normal;
    color: var(--c-secondary);
  }
  
  .archive-posts h3 {
    /* 移除 sticky 定位，让年份标题随页面正常滚动 */
    position: static;
    background: transparent;
    margin: 0;
    padding: 0;
  }
  
  /* 移动设备优化 */
  @media (max-width: 768px) {
    .archive-posts {
      margin-top: 2rem;
    }
    
    .archive-posts h2 {
      font-size: 1.5rem;
      margin-bottom: 1.5rem;
    }
    
    .year-number {
      font-size: 1.1rem;
      padding: 0.2rem 0.6rem;
    }
    
    .post-count {
      font-size: 0.8rem;
    }
    
    .archive-posts h3 {
      font-size: 1.2rem;
      margin-bottom: 1rem;
      position: static;
      margin: 0;
      padding: 0;
      background: transparent;
      backdrop-filter: none;
    }
    
    .archive-posts section {
      margin-bottom: 2rem;
    }
    
    .archive-posts section:hover {
      transform: none;
    }
  }
  
  /* 暗色模式适配 */
  @media (prefers-color-scheme: dark) {
    .archive-posts h3 {
      background: var(--c-bg);
    }
  }
</style>
