---
import type { CollectionEntry } from 'astro:content'
import PinIcon from '@/assets/icons/pin-icon.svg'
import PostDate from '@/components/PostDate.astro'
import { defaultLocale } from '@/config'
import { getPostDescription } from '@/utils/description'
import { isHomePage } from '@/utils/page'

type Post = CollectionEntry<'posts'> & {
  remarkPluginFrontmatter: {
    minutes: number
  }
}

const { posts, lang, pinned = false } = Astro.props
const isHome = isHomePage(Astro.url.pathname)

export interface Props {
  posts: Post[]
  lang: string
  pinned?: boolean
}

function getPostPath(post: Post) {
  // 使用 abbrlink 或者移除文件扩展名的 id 作为 slug
  const slug = post.id.replace(/\.(md|mdx)$/, '')

  if (lang === defaultLocale) {
    return `/posts/${slug}/`
  }

  return `/${lang}/posts/${slug}/`
}
---

<ul>
  {posts.map(post => (
    <li
      class="mb-5.5"
      lg={isHome ? 'mb-10' : ''}
    >
      {/* post title */}
      <h3 class="inline transition-colors hover:c-primary">
        <a
          class="cjk:tracking-0.02em"
          lg={isHome ? 'font-medium text-4.5' : ''}
          href={getPostPath(post)}
          transition:name={`post-${post.id}${lang ? `-${lang}` : ''}`}
          data-disable-theme-transition
        >
          {post.data.title}
        </a>
        {/* pinned icon */}
        {pinned && (
          <PinIcon
            aria-hidden="true"
            class="ml-0.25em inline-block aspect-square w-0.98em translate-y--0.1em lg:(w-1.05em translate-y--0.15em)"
            fill="currentColor"
          />
        )}
      </h3>

      {/* mobile post time */}
      <div
        class="py-0.8 text-3.5 font-time lg:hidden"
        transition:name={`time-${post.id}${lang ? `-${lang}` : ''}`}
        data-disable-theme-transition
      >
        <PostDate
          date={post.data.published}
          minutes={post.remarkPluginFrontmatter.minutes}
        />
      </div>

      {/* desktop post time */}
      <div class="hidden text-3.65 font-time lg:(ml-2.5 inline)">
        <PostDate
          date={post.data.published}
          minutes={post.remarkPluginFrontmatter.minutes}
        />
      </div>

      {/* post description - 显示在所有页面和设备上 */}
      <div
        class="heti mt-2"
        lg="mt-2.25"
      >
        <p class="line-clamp-2 text-sm c-secondary">{getPostDescription(post, 'list')}</p>
      </div>

      {/* post tags - 显示文章标签 */}
      {post.data.tags && post.data.tags.length > 0 && (
        <div class="mt-2 flex flex-wrap gap-2">
          {post.data.tags.slice(0, 5).map((tag: string) => (
            <span class="inline-block border border-secondary/20 rounded-full bg-secondary/10 px-2 py-0.5 text-xs c-secondary">
              #{tag}
            </span>
          ))}
          {post.data.tags.length > 5 && (
            <span class="text-xs c-secondary/70">+{post.data.tags.length - 5}</span>
          )}
        </div>
      )}
    </li>
  ))}
</ul>
